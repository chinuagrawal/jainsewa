<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Dashboard</title>

  <!-- Fonts + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --accent:#4a148c;
      --accent-2:#6a1b9a;
      --muted:#6b7280;
      --radius:12px;
      --shadow: 0 8px 24px rgba(20,20,40,0.06);
      --mobile-break:820px;
      --mobile-compact:520px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,"Helvetica Neue",Arial;}
    body{background: linear-gradient(180deg,#f7f8fc 0%, #eef2fb 100%); color:#111; -webkit-font-smoothing:antialiased}

    .app {
      max-width:1000px;
      margin:18px auto;
      padding:0 16px 110px; /* leave space for bottom bar */
    }

    /* Topbar */
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px }
    .brand { display:flex; gap:12px; align-items:center }
    .logo { width:52px; height:52px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px; box-shadow: 0 6px 18px rgba(74,20,140,0.14); }
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--muted)}

    .actions { display:flex; gap:8px; align-items:center; }
    .btn { border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:8px; }
    .btn-ghost { background:transparent; color:var(--accent); border:1px solid rgba(74,20,140,0.08); padding:8px 10px }
    .btn-primary { background:var(--accent); color:#fff; box-shadow: 0 6px 18px rgba(74,20,140,0.12) }

    .viewport { border-radius: var(--radius); overflow:hidden; box-shadow: var(--shadow) }

    .content { display:grid; grid-template-columns: 1fr 360px; gap:18px; padding:20px; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.97)); }

    /* Left column */
    .left { overflow:auto; max-height: calc(100vh - 240px); padding-right:8px }

    .profile-card { background:var(--card); border-radius:12px; padding:14px; display:flex; gap:12px; align-items:center; margin-bottom:12px; box-shadow:0 4px 12px rgba(16,24,40,0.04) }
    .avatar { width:64px; height:64px; border-radius:10px; display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent-2)); font-weight:700;font-size:18px }
    .profile-info h3{margin:0;font-size:17px}
    .profile-info p{margin:4px 0 0;color:var(--muted);font-size:13px}

    .card { background:var(--card); border-radius:12px; padding:14px; margin-bottom:12px; box-shadow:0 4px 12px rgba(16,24,40,0.04) }

    .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px }
    .kv { display:flex; flex-direction:column; padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfbff) }
    .kv b{font-size:13px;color:#222}
    .kv span{font-size:14px;color:var(--muted); margin-top:6px}

    .section-title{ margin:0 0 10px 0; font-size:15px; color:var(--accent) }

    /* Right column */
    .right { display:flex; flex-direction:column; gap:14px; max-height: calc(100vh - 240px); overflow:auto; padding-left:8px }
    .stat-row { display:flex; gap:10px }
    .stat { flex:1; padding:12px; border-radius:10px; background:linear-gradient(180deg,#fff,#fafafa); text-align:center }
    .stat b{display:block;font-size:18px;color:var(--accent)}
    .stat small{color:var(--muted)}

    .appointments { max-height:220px; overflow:auto; margin-top:6px }
    .appt { padding:10px; border-radius:10px; display:flex; justify-content:space-between; gap:8px; margin-bottom:8px; background:linear-gradient(180deg,#fff,#fbfbff) }

    /* sticky pay bar */
    .paybar { position:fixed; left:0; right:0; bottom:0; display:flex; justify-content:center; padding:12px; background: linear-gradient(90deg, rgba(250,250,255,0.95), rgba(255,255,255,0.95)); box-shadow:0 -6px 30px rgba(16,24,40,0.08); z-index:60 }
    .paybar-inner { width:100%; max-width:1000px; display:flex; gap:12px; align-items:center; padding:4px }
    .pay-cta { flex:1; display:flex; gap:12px; align-items:center }
    .pay-price { font-weight:700; font-size:17px; margin-right:10px; color:var(--accent) }
    .pay-button { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; border:0; padding:12px 18px; border-radius:12px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:10px; box-shadow:0 8px 24px rgba(74,20,140,0.18) }

    /* sheet */
    .sheet { position:fixed; left:0; right:0; bottom:0; transform:translateY(110%); transition:transform .36s cubic-bezier(.2,.9,.3,1); background: linear-gradient(180deg,#fff,#fbfbff); border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -18px 50px rgba(16,24,40,0.18); z-index:80; padding:14px; max-height:78vh; overflow:auto }
    .sheet.open { transform:translateY(0) }
    .sheet .handle { width:54px; height:6px; background:#eee; border-radius:6px; margin:6px auto 12px; }

    .sheet-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px }
    .sheet .row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee }
    .sheet .row:last-child { border-bottom:none }
    .confirm { margin-top:14px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; border:0; padding:12px; border-radius:10px; width:100%; font-weight:700; cursor:pointer }

    /* ----- MOBILE STYLES ----- */
    @media (max-width:820px){
      .content { grid-template-columns: 1fr; padding:14px; gap:12px }
      .right { order:2; padding-left:0 }
      .left { order:1 }
      .grid { grid-template-columns: repeat(2, 1fr) } /* keep two columns for medium-phone */
      .profile-card { padding:12px }
      .avatar { width:56px; height:56px; font-size:16px }
      .logo { width:46px; height:46px; font-size:16px }
      .app { padding-bottom:150px }
    }

    @media (max-width:520px){
      /* compact header */
      .brand h1{font-size:16px}
      .brand p{font-size:11px}
      .actions .btn { padding:8px; border-radius:8px }
      /* details become single column for easy scrolling */
      .grid { grid-template-columns: 1fr; gap:8px }
      .kv { padding:12px }
      .paybar-inner { padding:6px }
      .pay-price { font-size:15px }
      .pay-button { padding:14px; width:46%; min-width:140px }
      /* make pay button full width if screen narrow */
      .paybar-inner { flex-direction:row; align-items:center }
      .pay-cta { gap:8px }
      /* If extremely narrow, make pay button full width & price stacked */
      @media (max-width:400px){
        .paybar-inner { flex-direction:column; align-items:stretch; gap:8px }
        .pay-button { width:100% }
        .pay-cta { flex-direction:row; align-items:center }
        .pay-price { font-size:16px }
      }

      /* sheet: full-screen modal vibe */
      .sheet { border-top-left-radius:12px; border-top-right-radius:12px; max-height:94vh; padding:12px; }
      .sheet.open { transform:translateY(0) }
      .sheet .confirm { padding:14px }
      .profile-info h3{font-size:16px}
    }

    /* tiny adjustments for touch */
    button, .pay-button, .confirm { -webkit-tap-highlight-color: rgba(0,0,0,0.05) }
  </style>
</head>
<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo">JS</div>
        <div>
          <h1>JainSewa</h1>
          <p>Patient Dashboard</p>
        </div>
      </div>

      <div class="actions" id="topActions">
        <!-- On mobile these become compact -->
        <button class="btn btn-ghost" id="editProfile" title="Edit"><i class="ri-edit-line"></i></button>
        <button class="btn btn-ghost" id="contactBtn" title="Contact"><i class="ri-phone-line"></i></button>
        <button class="btn btn-ghost" id="logoutBtn" title="Logout"><i class="ri-logout-box-r-line"></i></button>
      </div>
    </div>

    <div class="viewport">
      <div class="content">

        <!-- LEFT -->
        <div class="left">
          <!-- profile -->
          <div class="profile-card card">
            <div class="avatar" id="avatar">JD</div>
            <div class="profile-info">
              <h3 id="pname">—</h3>
              <p id="pemail">—</p>
              <p style="margin-top:8px;color:var(--muted);font-size:13px" id="pmobile">—</p>
            </div>
          </div>

          <!-- personal details -->
          <div class="card">
            <h2 class="section-title">My Details (मेरी जानकारी)</h2>
            <div style="margin-top:10px" id="detailsGrid" class="grid">
              <!-- dynamic kv elements -->
            </div>
          </div>

          <!-- medical notes -->
          <div class="card">
            <h2 class="section-title">Medical Notes</h2>
            <p id="medNotes" style="color:var(--muted);margin:0">No notes available. You can add notes after consulting a doctor.</p>
          </div>

          <!-- recent payments -->
          <div class="card">
            <h2 class="section-title">Recent Payments</h2>
            <div id="paymentsList" style="margin-top:8px">
              <div style="color:var(--muted)">No recent payments</div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="right">
          <div class="card stat-row">
            <div class="stat">
              <b id="totalConsults">0</b>
              <small>Consultations</small>
            </div>
            <div class="stat">
              <b id="pending">0</b>
              <small>Pending</small>
            </div>
          </div>

          <div class="card">
            <h2 class="section-title">Upcoming Appointments</h2>
            <div class="appointments" id="appts">
              <div style="color:var(--muted)">No upcoming appointments</div>
            </div>
          </div>

          <div class="card">
            <h2 class="section-title">Quick Actions</h2>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn btn-primary" id="newAppt"><i class="ri-calendar-plus-line"></i> Book Appointment</button>
              <button class="btn btn-ghost" id="viewHistory"><i class="ri-heart-pulse-line"></i> View History</button>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- Sticky pay bar -->
  <div class="paybar" aria-hidden="false">
    <div class="paybar-inner">
      <div class="pay-cta">
        <div style="display:flex;flex-direction:column">
          <div style="font-size:13px;color:var(--muted)">Consultation Fee</div>
          <div class="pay-price">₹<span id="feeAmount">500</span></div>
        </div>
        <div style="flex:1"></div>
        <button class="pay-button" id="openPay"><i class="ri-wallet-line"></i> Pay Now</button>
      </div>
    </div>
  </div>

  <!-- Slide-up payment sheet -->
  <div class="sheet" id="sheet">
    <div class="handle" aria-hidden="true"></div>
    <div class="sheet-header">
      <strong>Payment — Doctor Consultation</strong>
      <button id="closeSheet" class="btn btn-ghost" style="padding:6px 10px"><i class="ri-close-line"></i></button>
    </div>

    <div class="row">
      <div><small>Patient</small><div id="s_name"><strong>—</strong></div></div>
      <div style="text-align:right"><small>Mobile</small><div id="s_mobile"><strong>—</strong></div></div>
    </div>

    <div class="row">
      <div><small>Fee</small><div id="s_fee"><strong>₹500</strong></div></div>
      <div style="text-align:right"><small>Payment Method</small><div><select id="paymentMethod" style="padding:8px;border-radius:8px;border:1px solid #eee">
        <option value="phonepe">PhonePe</option>
        <option value="upi">UPI</option>
        <option value="card">Card</option>
      </select></div></div>
    </div>

    <div style="margin-top:12px">
      <label style="display:block;font-size:13px;color:var(--muted)">Notes for doctor (optional)</label>
      <textarea id="payNotes" rows="3" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:6px"></textarea>
    </div>

    <button class="confirm" id="confirmPay">Proceed to Pay</button>
  </div>

  <script>
    // --- initial
    const user = JSON.parse(localStorage.getItem('user'));
    if(!user) {
      window.location.href = 'login.html';
    }

    const feeAmount = document.getElementById('feeAmount');
    const sheet = document.getElementById('sheet');
    const openPay = document.getElementById('openPay');
    const closeSheet = document.getElementById('closeSheet');
    const confirmPay = document.getElementById('confirmPay');

    // Fill minimal UI from localStorage while fetching details
    document.getElementById('pname').innerText = (user.firstName ? user.firstName + (user.lastName? ' ' + user.lastName : '') : '—');
    document.getElementById('pemail').innerText = user.email || '—';
    document.getElementById('pmobile').innerText = user.mobile || '—';
    document.getElementById('avatar').innerText = (user.firstName ? user.firstName.charAt(0).toUpperCase() : 'P') + (user.lastName ? user.lastName.charAt(0).toUpperCase() : '');

    // Fetch full user details
    fetch(`http://localhost:3000/api/user/${user.mobile}`)
      .then(r => {
        if(!r.ok) throw new Error('Failed to fetch');
        return r.json();
      })
      .then(data => {
        const keys = [
          ['First Name', 'firstName'],
          ['Last Name', 'lastName'],
          ['Email', 'email'],
          ['DOB', 'dob'],
          ['Gender', 'gender'],
          ['City', 'city'],
          ['State', 'state'],
          ['Disease', 'disease'],
          ['Mobile', 'mobile']
        ];
        const grid = document.getElementById('detailsGrid');
        grid.innerHTML = '';
        keys.forEach(([label, key])=>{
          const div = document.createElement('div');
          div.className = 'kv';
          div.innerHTML = `<b>${label}</b><span>${data[key] || 'N/A'}</span>`;
          grid.appendChild(div);
        });

        document.getElementById('pname').innerText = `${data.firstName || ''} ${data.lastName || ''}`.trim() || '—';
        document.getElementById('pemail').innerText = data.email || '—';
        document.getElementById('pmobile').innerText = data.mobile || '—';
        document.getElementById('s_name').innerText = document.getElementById('pname').innerText;
        document.getElementById('s_mobile').innerText = data.mobile || '—';

        document.getElementById('paymentsList').innerHTML = `<div style="color:var(--muted)">No recent payments</div>`;
        document.getElementById('totalConsults').innerText = 0;
        document.getElementById('pending').innerText = 0;
      })
      .catch(err => {
        console.error(err);
      });

    // Payment sheet open/close
    openPay.addEventListener('click', ()=> {
      sheet.classList.add('open');
      document.getElementById('s_fee').innerText = `₹${feeAmount.innerText}`;
      document.getElementById('s_name').innerText = document.getElementById('pname').innerText;
      document.getElementById('s_mobile').innerText = document.getElementById('pmobile').innerText;
      // scroll sheet to top
      setTimeout(()=> sheet.scrollTop = 0, 120);
    });
    closeSheet.addEventListener('click', ()=> sheet.classList.remove('open'));
    window.addEventListener('keydown', e => { if(e.key==='Escape') sheet.classList.remove('open') });

    // Confirm pay -> call /api/payment/initiate, then redirect to gateway using returned redirectUrl
    confirmPay.addEventListener('click', async function(){
      const notes = document.getElementById('payNotes').value || '';
      const paymentMethod = document.getElementById('paymentMethod').value || 'phonepe';
      const amount = Number(feeAmount.innerText) || 500;

      confirmPay.innerText = 'Processing...';
      confirmPay.disabled = true;

      try {
        const res = await fetch('http://localhost:3000/api/payment/initiate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            amount,
            email: (user.email || ''),
            mobile: (user.mobile || ''),
            purpose: 'Doctor Consultation',
            notes,
            paymentMethod
          })
        });
        const data = await res.json();
        if(res.ok && data.redirectUrl) {
          window.location.href = data.redirectUrl;
        } else {
          alert(data.message || 'Payment initiation failed. Please try again.');
        }
      } catch(err) {
        console.error(err);
        alert('Server error while initiating payment.');
      } finally {
        confirmPay.innerText = 'Proceed to Pay';
        confirmPay.disabled = false;
      }
    });

    // Quick actions
    document.getElementById('logoutBtn').addEventListener('click', ()=> {
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    });
    document.getElementById('editProfile').addEventListener('click', ()=> {
      window.location.href = 'signup.html';
    });
    document.getElementById('contactBtn').addEventListener('click', ()=> {
      window.location.href = 'tel:8870969514';
    });
    document.getElementById('newAppt').addEventListener('click', ()=> {
      alert('Appointment booking not implemented in this demo.');
    });
    document.getElementById('viewHistory').addEventListener('click', ()=> {
      alert('History page not implemented in this demo.');
    });

  </script>
</body>
</html>
